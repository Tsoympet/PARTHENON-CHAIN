---
name: "parthenon-win-0.1"
enable_cache: true
distro: "ubuntu"
suites:
- "focal"
architectures:
- "amd64"
packages:
- "g++"
- "gcc"
- "cmake"
- "ninja-build"
- "mingw-w64"
- "g++-mingw-w64-x86-64"
- "nsis"
- "zip"
- "ca-certificates"
- "python3"
- "pkg-config"
- "autoconf"
- "automake"
- "libtool"
- "git"

remotes:
- "url": "https://github.com/Tsoympet/PARTHENON-CHAIN.git"
  "dir": "parthenon-chain"

files:
- "openssl-3.0.13.tar.gz"
- "boost_1_83_0.tar.gz"

script: |
  WRAP_DIR=$HOME/wrapped
  HOSTS="x86_64-w64-mingw32"
  
  export TZ="UTC"
  export BUILD_DIR=`pwd`
  export SOURCE_DATE_EPOCH=1
  export LC_ALL=C
  
  # Build OpenSSL for Windows
  tar xzf openssl-3.0.13.tar.gz
  cd openssl-3.0.13
  ./Configure mingw64 --cross-compile-prefix=x86_64-w64-mingw32- \
    --prefix=$BUILD_DIR/deps no-shared
  make -j$(nproc)
  make install_sw
  cd ..
  
  # Build Boost for Windows
  tar xzf boost_1_83_0.tar.gz
  cd boost_1_83_0
  ./bootstrap.sh
  echo "using gcc : mingw : x86_64-w64-mingw32-g++ ;" > user-config.jam
  ./b2 --with-system toolset=gcc-mingw target-os=windows \
    variant=release link=static threading=multi runtime-link=static \
    --prefix=$BUILD_DIR/deps install -j$(nproc)
  cd ..
  
  # Build LevelDB for Windows
  git clone --depth 1 --branch 1.23 https://github.com/google/leveldb.git
  cd leveldb
  mkdir build-win
  # Create toolchain file
  cat > ../mingw-toolchain.cmake << 'ENDTOOLCHAIN'
  set(CMAKE_SYSTEM_NAME Windows)
  set(CMAKE_SYSTEM_PROCESSOR x86_64)
  
  set(CMAKE_C_COMPILER x86_64-w64-mingw32-gcc)
  set(CMAKE_CXX_COMPILER x86_64-w64-mingw32-g++)
  set(CMAKE_RC_COMPILER x86_64-w64-mingw32-windres)
  
  set(CMAKE_FIND_ROOT_PATH /usr/x86_64-w64-mingw32)
  set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
  set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
  set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
  
  set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -static-libgcc")
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -static-libgcc -static-libstdc++")
  set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -static -lpthread")
  ENDTOOLCHAIN
  cmake -S . -B build-win -G Ninja \
    -DCMAKE_TOOLCHAIN_FILE=$BUILD_DIR/mingw-toolchain.cmake \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=$BUILD_DIR/deps \
    -DLEVELDB_BUILD_TESTS=OFF \
    -DLEVELDB_BUILD_BENCHMARKS=OFF \
    -DBUILD_SHARED_LIBS=OFF
  cmake --build build-win --parallel
  cmake --install build-win
  cd ..
  
  # Build PARTHENON CHAIN
  cd parthenon-chain
  VERSION=$(cat CMakeLists.txt | grep "VERSION" | head -1 | awk '{print $2}' | tr -d ')')
  
  mkdir -p build-win
  cd build-win
  
  cmake .. \
    -GNinja \
    -DCMAKE_TOOLCHAIN_FILE=$BUILD_DIR/mingw-toolchain.cmake \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_PREFIX_PATH=$BUILD_DIR/deps \
    -DOPENSSL_ROOT_DIR=$BUILD_DIR/deps \
    -DBoost_INCLUDE_DIR=$BUILD_DIR/deps/include \
    -DDRACHMA_BUILD_GUI=OFF \
    -DDRACHMA_BUILD_TESTS=OFF \
    -DDRACHMA_COVERAGE=OFF \
    -DCMAKE_C_FLAGS="-O2 -march=x86-64 -fno-asynchronous-unwind-tables" \
    -DCMAKE_CXX_FLAGS="-O2 -march=x86-64 -fno-asynchronous-unwind-tables"
  
  ninja
  
  # Package binaries
  mkdir -p $OUTDIR/bin
  TARGETS=(drachmad.exe drachma-cli.exe drachma_cpu_miner.exe)
  for name in "${TARGETS[@]}"; do
    bin_path=$(find . -maxdepth 3 -type f -name "${name}" -print -quit)
    if [ -n "${bin_path}" ]; then
      x86_64-w64-mingw32-strip --strip-all "${bin_path}"
      cp "${bin_path}" $OUTDIR/bin/
    else
      echo "Warning: ${name} was not produced; skipping." >&2
    fi
  done
  
  cd $OUTDIR
  # Create release archive
  find . -type f | sort | tar --mtime="@${SOURCE_DATE_EPOCH}" \
    --mode='u+rw,go+r-w,a+X' --owner=0 --group=0 --sort=name \
    --no-recursion -T - -czf $OUTDIR/../parthenon-core-${VERSION}-win-x86_64.tar.gz
