version: '3.9'

x-node-common: &node-common
  build: .
  image: drachma/node:latest
  restart: unless-stopped
  environment:
    NETWORK: testnet
  logging:
    options:
      max-size: "10m"
      max-file: "3"

services:
  drachma-seed-a:
    <<: *node-common
    container_name: drachma-seed-a
    volumes:
      - drachma-seed-a:/opt/drachma/.drachma
    ports:
      - "19335:19335"  # P2P
      - "18332:18332"  # RPC
      - "9311:9311"    # metrics
    command: ["--network", "testnet", "--rpcuser", "user", "--rpcpassword", "pass", "--listen", "--port=19335", "--rpcport=18332", "--metricsport=9311"]

  drachma-seed-b:
    <<: *node-common
    container_name: drachma-seed-b
    depends_on:
      - drachma-seed-a
    volumes:
      - drachma-seed-b:/opt/drachma/.drachma
    ports:
      - "19336:19335"
      - "18333:18332"
    command: ["--network", "testnet", "--rpcuser", "user", "--rpcpassword", "pass", "--listen", "--port=19335", "--rpcport=18332", "--metricsport=9311", "--addnode=drachma-seed-a"]

  drachma-node-1:
    <<: *node-common
    container_name: drachma-node-1
    depends_on:
      - drachma-seed-a
      - drachma-seed-b
    volumes:
      - drachma-node-1:/opt/drachma/.drachma
    ports:
      - "19337:19335"
      - "18334:18332"
    command: ["--network", "testnet", "--rpcuser", "user", "--rpcpassword", "pass", "--listen", "--port=19335", "--rpcport=18332", "--metricsport=9311", "--addnode=drachma-seed-a", "--addnode=drachma-seed-b"]

  drachma-node-2:
    <<: *node-common
    container_name: drachma-node-2
    depends_on:
      - drachma-seed-a
      - drachma-seed-b
    volumes:
      - drachma-node-2:/opt/drachma/.drachma
    command: ["--network", "testnet", "--rpcuser", "user", "--rpcpassword", "pass", "--listen", "--port=19335", "--rpcport=18332", "--metricsport=9311", "--addnode=drachma-seed-a", "--addnode=drachma-seed-b"]

  drachma-node-3:
    <<: *node-common
    container_name: drachma-node-3
    depends_on:
      - drachma-seed-a
      - drachma-seed-b
    volumes:
      - drachma-node-3:/opt/drachma/.drachma
    command: ["--network", "testnet", "--rpcuser", "user", "--rpcpassword", "pass", "--listen", "--port=19335", "--rpcport=18332", "--metricsport=9311", "--addnode=drachma-seed-a", "--addnode=drachma-seed-b"]

  drachma-dashboard:
    image: nginx:alpine
    container_name: drachma-dashboard
    restart: unless-stopped
    depends_on:
      - drachma-node-1
    volumes:
      - ./testnet/dashboard.html:/usr/share/nginx/html/index.html:ro
    environment:
      - RPC_URL=http://drachma-node-1:18332
    ports:
      - "8080:80"

  faucet:
    build: .
    image: drachma/faucet:latest
    container_name: drachma-faucet
    restart: on-failure
    depends_on:
      - drachma-node-1
    environment:
      RPC_URL: http://drachma-node-1:18332
      RPC_USER: user
      RPC_PASSWORD: pass
    command: ["python3", "testnet/faucet.py", "--rpc", "http://drachma-node-1:18332", "--rpcuser", "user", "--rpcpassword", "pass", "--amount", "1", "--state-file", "/var/lib/faucet/state.json", "tb1qplaceholder"]
    volumes:
      - faucet-state:/var/lib/faucet

  prometheus:
    image: prom/prometheus:latest
    container_name: drachma-prometheus
    restart: unless-stopped
    volumes:
      - ./testnet/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:latest
    container_name: drachma-grafana
    restart: unless-stopped
    depends_on:
      - prometheus
    environment:
      GF_SECURITY_ADMIN_PASSWORD: drachma
    volumes:
      - grafana-data:/var/lib/grafana
      - ./testnet/monitoring/grafana_dashboard.json:/var/lib/grafana/dashboards/drachma.json:ro
    ports:
      - "3000:3000"

  node-monitor:
    build: .
    image: drachma/tools:latest
    container_name: drachma-node-monitor
    depends_on:
      - drachma-node-1
      - drachma-node-2
      - drachma-node-3
    command: ["python3", "scripts/node_monitor.py", "--nodes", "http://drachma-node-1:18332,http://drachma-node-2:18332,http://drachma-node-3:18332", "--user", "user", "--password", "pass", "--interval", "15"]

volumes:
  drachma-seed-a:
  drachma-seed-b:
  drachma-node-1:
  drachma-node-2:
  drachma-node-3:
  faucet-state:
  grafana-data:
