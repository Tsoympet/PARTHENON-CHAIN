version: '3.9'
services:
  drachma-node-a:
    build: .
    image: drachma/node:latest
    container_name: drachma-node-a
    restart: unless-stopped
    volumes:
      - drachma-data-a:/opt/drachma/.drachma
    ports:
      - "19335:19335"  # P2P
      - "18332:18332"  # RPC
    command: ["--network", "testnet", "--rpcuser", "user", "--rpcpassword", "pass", "--listen", "--metricsport=9311"]

  drachma-node-b:
    build: .
    image: drachma/node:latest
    container_name: drachma-node-b
    restart: unless-stopped
    depends_on:
      - drachma-node-a
    volumes:
      - drachma-data-b:/opt/drachma/.drachma
    ports:
      - "19336:19336"
      - "18333:18333"
    command: ["--network", "testnet", "--rpcuser", "user", "--rpcpassword", "pass", "--listen", "--metricsport=9311", "--addnode=drachma-node-a"]

  faucet:
    build: .
    image: drachma/faucet:latest
    container_name: drachma-faucet
    restart: on-failure
    depends_on:
      - drachma-node-a
    environment:
      RPC_URL: http://drachma-node-a:18332
      RPC_USER: user
      RPC_PASSWORD: pass
    command: ["python3", "testnet/faucet.py", "--rpc", "http://drachma-node-a:18332", "--rpcuser", "user", "--rpcpassword", "pass", "--amount", "1", "tb1qplaceholder"]

  prometheus:
    image: prom/prometheus:latest
    container_name: drachma-prometheus
    restart: unless-stopped
    volumes:
      - ./testnet/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:latest
    container_name: drachma-grafana
    restart: unless-stopped
    depends_on:
      - prometheus
    environment:
      GF_SECURITY_ADMIN_PASSWORD: drachma
    volumes:
      - grafana-data:/var/lib/grafana
      - ./testnet/monitoring/grafana_dashboard.json:/var/lib/grafana/dashboards/drachma.json:ro
    ports:
      - "3000:3000"

volumes:
  drachma-data-a:
  drachma-data-b:
  grafana-data:
