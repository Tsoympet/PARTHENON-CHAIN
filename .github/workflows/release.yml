name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version_tag:
        description: "Version label to use when manually triggering"
        required: true
        default: "v0.0.0-devtest"
      publish_release:
        description: "Publish a GitHub release (false for dry-run)"
        type: choice
        options: ["false", "true"]
        default: "false"
        required: true

permissions:
  contents: write
  id-token: write

env:
  BUILD_TYPE: Release

jobs:
  build:
    name: Build and package (ubuntu-latest)
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event_name == 'workflow_dispatch' && inputs.version_tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build libssl-dev libboost-all-dev libleveldb-dev

      - name: Configure
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -DDRACHMA_BUILD_GUI=OFF -DDRACHMA_BUILD_TESTS=OFF

      - name: Build
        run: cmake --build build --parallel

      - name: Package artifacts
        run: |
          mkdir -p dist/ubuntu
          cp build/layer1-core/drachmad dist/ubuntu/ || true
          cp build/layer1-core/drachma-cli dist/ubuntu/ || true
          cp build/drachma_cpu_miner dist/ubuntu/ || true
          if [ -z "$(find dist/ubuntu -maxdepth 1 -type f -print -quit)" ]; then
            echo "No binaries were packaged from the build output." >&2
            exit 1
          fi
          tar -czf dist/drachma-${VERSION}-linux.tar.gz -C dist/ubuntu .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-ubuntu
          path: dist/drachma-${{ env.VERSION }}-linux.tar.gz

  publish:
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish_release == 'true')
    name: Publish release
    needs: build
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event_name == 'workflow_dispatch' && inputs.version_tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
          if-no-artifacts-found: error

      - name: Prepare release assets
        run: |
          ls -R artifacts
          mkdir -p dist
          find artifacts -type f -name '*.tar.gz' -exec cp {} dist/ \;
          if [ -z "$(find dist -type f -print -quit)" ]; then
            echo "No packaged artifacts found." >&2
            exit 1
          fi

      - name: Compose release notes
        run: |
          if grep -q "^## \\[${VERSION}\\]" CHANGELOG.md; then
            sed -n "/^## \\[${VERSION}\\]/,/^## /p" CHANGELOG.md | sed '$d' > release_notes.md
          else
            echo "Drachma ${VERSION}" > release_notes.md
            echo "Release notes not found in CHANGELOG.md" >> release_notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'push' && github.ref_name || inputs.version_tag }}
          name: Drachma ${{ env.VERSION }}
          body_path: release_notes.md
          files: dist/*
          draft: false
          prerelease: ${{ contains(env.VERSION, 'rc') || contains(env.VERSION, 'test') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
