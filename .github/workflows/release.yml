---
name: Release

'on':
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version_tag:
        description: "Version label to use when manually triggering"
        required: true
        default: "v0.0.0-devtest"
      publish_release:
        description: "Publish a GitHub release (false for dry-run)"
        type: choice
        options: ["false", "true"]
        default: "false"
        required: true

permissions:
  contents: write
  id-token: write

env:
  BUILD_TYPE: Release

jobs:
  build-linux:
    name: Build Linux x86_64
    runs-on: ubuntu-20.04
    env:
      BUILD_DIR: build
      VERSION: >-
        ${{ github.event_name == 'workflow_dispatch' &&
        inputs.version_tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: >-
          sudo apt-get update && sudo apt-get install -y
          cmake ninja-build libssl-dev libboost-all-dev libleveldb-dev

      - name: Configure (reproducible build)
        env:
          SOURCE_DATE_EPOCH: "1"
          TZ: "UTC"
          LC_ALL: "C"
        run: >-
          cmake -S . -B "${BUILD_DIR}" -G Ninja
          -DCMAKE_BUILD_TYPE="${BUILD_TYPE}"
          -DDRACHMA_BUILD_GUI=OFF
          -DDRACHMA_BUILD_TESTS=ON
          -DDRACHMA_COVERAGE=OFF
          -DCMAKE_C_FLAGS="-O2 -march=x86-64 -fno-asynchronous-unwind-tables"
          -DCMAKE_CXX_FLAGS="-O2 -march=x86-64 -fno-asynchronous-unwind-tables"
          -DCMAKE_EXE_LINKER_FLAGS="-Wl,--build-id=none"

      - name: Build
        run: cmake --build "${BUILD_DIR}" --parallel

      - name: Test
        run: ctest --test-dir "${BUILD_DIR}" --output-on-failure

      - name: Package artifacts
        run: |
          mkdir -p dist/parthenon-core
          TARGETS=(drachmad drachma-cli drachma_cpu_miner)
          for name in "${TARGETS[@]}"; do
            bin_path=$(find "${BUILD_DIR}" -maxdepth 3 -type f \
              -name "${name}" -print -quit)
            if [ -n "${bin_path}" ]; then
              strip --strip-all "${bin_path}"
              cp "${bin_path}" dist/parthenon-core/
            else
              echo "Warning: ${name} was not produced; skipping." >&2
            fi
          done
          
          # Add documentation
          cp README.md dist/parthenon-core/
          cp LICENSE dist/parthenon-core/
          echo "${VERSION}" > dist/parthenon-core/VERSION
          
          # Create README.txt for release
          cat > dist/parthenon-core/README.txt << 'EOF'
          PARTHENON CHAIN - Core Client Binaries
          
          This archive contains the core binaries for running a PARTHENON CHAIN node.
          
          Binaries included:
          - drachmad: The core daemon (full node)
          - drachma-cli: Command-line RPC interface
          - drachma_cpu_miner: CPU mining software
          
          Quick Start:
          1. Run './drachmad --help' to see available options
          2. Start the daemon: './drachmad'
          3. Use the CLI: './drachma-cli getblockcount'
          
          For detailed documentation, see:
          - Installation: docs/install.md (or visit GitHub)
          - Verification: docs/verifying-downloads.md
          - GitHub: https://github.com/Tsoympet/PARTHENON-CHAIN
          
          Security:
          - Always verify checksums before running binaries
          - Verify GPG signatures if available
          - See docs/verifying-downloads.md for instructions
          EOF
          
          # Generate checksums
          cd dist/parthenon-core
          sha256sum drachmad drachma-cli drachma_cpu_miner > SHA256SUMS
          cd ../..
          
          # Create archive
          tar -czf dist/parthenon-core-${VERSION}-linux-x86_64.tar.gz -C dist/parthenon-core .
          
          # Generate archive checksum
          cd dist
          sha256sum parthenon-core-${VERSION}-linux-x86_64.tar.gz > parthenon-core-${VERSION}-linux-x86_64.tar.gz.sha256
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-linux-x86_64
          path: |
            dist/parthenon-core-${{ env.VERSION }}-linux-x86_64.tar.gz
            dist/parthenon-core-${{ env.VERSION }}-linux-x86_64.tar.gz.sha256

  build-windows:
    name: Build Windows x86_64
    runs-on: ubuntu-20.04
    env:
      BUILD_DIR: build-win
      VERSION: >-
        ${{ github.event_name == 'workflow_dispatch' &&
        inputs.version_tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install MinGW and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            mingw-w64 g++-mingw-w64-x86-64 \
            wine64 zip

      - name: Create CMake toolchain file
        run: |
          mkdir -p cmake
          cat > cmake/mingw-w64-x86_64.cmake << 'EOF'
          set(CMAKE_SYSTEM_NAME Windows)
          set(CMAKE_SYSTEM_PROCESSOR x86_64)
          
          set(CMAKE_C_COMPILER x86_64-w64-mingw32-gcc)
          set(CMAKE_CXX_COMPILER x86_64-w64-mingw32-g++)
          set(CMAKE_RC_COMPILER x86_64-w64-mingw32-windres)
          
          set(CMAKE_FIND_ROOT_PATH /usr/x86_64-w64-mingw32)
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          
          set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -static-libgcc")
          set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -static-libgcc -static-libstdc++")
          set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -static -lpthread")
          EOF

      - name: Build OpenSSL for Windows
        run: |
          wget -q https://www.openssl.org/source/openssl-3.0.13.tar.gz
          tar xzf openssl-3.0.13.tar.gz
          cd openssl-3.0.13
          ./Configure mingw64 --cross-compile-prefix=x86_64-w64-mingw32- \
            --prefix=$PWD/../deps no-shared
          make -j$(nproc)
          make install_sw
          cd ..

      - name: Build Boost for Windows
        run: |
          wget -q https://boostorg.jfrog.io/artifactory/main/release/1.83.0/source/boost_1_83_0.tar.gz
          tar xzf boost_1_83_0.tar.gz
          cd boost_1_83_0
          ./bootstrap.sh
          echo "using gcc : mingw : x86_64-w64-mingw32-g++ ;" > user-config.jam
          ./b2 --with-system --with-filesystem --with-thread --with-program_options \
            toolset=gcc-mingw target-os=windows variant=release \
            link=static threading=multi runtime-link=static \
            --prefix=$PWD/../deps install -j$(nproc)
          cd ..

      - name: Build LevelDB for Windows
        run: |
          git clone --depth 1 --branch 1.23 https://github.com/google/leveldb.git
          cd leveldb
          mkdir build-win
          cmake -S . -B build-win -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=$PWD/../cmake/mingw-w64-x86_64.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$PWD/../deps \
            -DLEVELDB_BUILD_TESTS=OFF \
            -DLEVELDB_BUILD_BENCHMARKS=OFF \
            -DBUILD_SHARED_LIBS=OFF
          cmake --build build-win --parallel
          cmake --install build-win
          cd ..

      - name: Configure (reproducible build)
        env:
          SOURCE_DATE_EPOCH: "1"
          TZ: "UTC"
          LC_ALL: "C"
        run: |
          cmake -S . -B "${BUILD_DIR}" -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=$PWD/cmake/mingw-w64-x86_64.cmake \
            -DCMAKE_BUILD_TYPE="${BUILD_TYPE}" \
            -DCMAKE_PREFIX_PATH=$PWD/deps \
            -DOPENSSL_ROOT_DIR=$PWD/deps \
            -DBoost_INCLUDE_DIR=$PWD/deps/include \
            -DDRACHMA_BUILD_GUI=OFF \
            -DDRACHMA_BUILD_TESTS=OFF \
            -DDRACHMA_COVERAGE=OFF \
            -DCMAKE_C_FLAGS="-O2 -march=x86-64 -fno-asynchronous-unwind-tables" \
            -DCMAKE_CXX_FLAGS="-O2 -march=x86-64 -fno-asynchronous-unwind-tables"

      - name: Build
        run: cmake --build "${BUILD_DIR}" --parallel

      - name: Package artifacts
        run: |
          mkdir -p dist/parthenon-core
          TARGETS=(drachmad.exe drachma-cli.exe drachma_cpu_miner.exe)
          for name in "${TARGETS[@]}"; do
            bin_path=$(find "${BUILD_DIR}" -maxdepth 3 -type f \
              -name "${name}" -print -quit)
            if [ -n "${bin_path}" ]; then
              x86_64-w64-mingw32-strip --strip-all "${bin_path}"
              cp "${bin_path}" dist/parthenon-core/
            else
              echo "Warning: ${name} was not produced; skipping." >&2
            fi
          done
          
          # Add documentation
          cp README.md dist/parthenon-core/
          cp LICENSE dist/parthenon-core/
          echo "${VERSION}" > dist/parthenon-core/VERSION
          
          # Create README.txt for release
          cat > dist/parthenon-core/README.txt << 'EOF'
          PARTHENON CHAIN - Core Client Binaries (Windows x86_64)
          
          This archive contains the core binaries for running a PARTHENON CHAIN node on Windows.
          
          Binaries included:
          - drachmad.exe: The core daemon (full node)
          - drachma-cli.exe: Command-line RPC interface
          - drachma_cpu_miner.exe: CPU mining software
          
          System Requirements:
          - Windows 10 or later (64-bit)
          - 8GB RAM minimum (16GB recommended)
          - 50GB free disk space
          
          Quick Start:
          1. Extract all files to a folder (e.g., C:\PARTHENON-CHAIN)
          2. Open PowerShell or Command Prompt
          3. Run 'drachmad.exe --help' to see available options
          4. Start the daemon: 'drachmad.exe'
          5. Use the CLI: 'drachma-cli.exe getblockcount'
          
          For detailed documentation, see:
          - Installation: docs/install.md (or visit GitHub)
          - Verification: docs/verifying-downloads.md
          - GitHub: https://github.com/Tsoympet/PARTHENON-CHAIN
          
          Security:
          - Always verify checksums before running binaries
          - Verify GPG signatures if available
          - See docs/verifying-downloads.md for instructions
          
          To verify checksums in PowerShell:
            $hash = (Get-FileHash drachmad.exe -Algorithm SHA256).Hash
            $expected = (Get-Content SHA256SUMS | Select-String drachmad.exe).ToString().Split()[0]
            if ($hash -eq $expected) { Write-Host "Checksum verified!" } else { Write-Host "WARNING: Checksum mismatch!" }
          EOF
          
          # Generate checksums - verify all expected binaries are present
          cd dist/parthenon-core
          EXPECTED_BINS=(drachmad.exe drachma-cli.exe drachma_cpu_miner.exe)
          for bin in "${EXPECTED_BINS[@]}"; do
            if [ ! -f "$bin" ]; then
              echo "Error: Expected binary $bin not found!" >&2
              exit 1
            fi
          done
          sha256sum "${EXPECTED_BINS[@]}" > SHA256SUMS
          cd ../..
          
          # Create archive
          cd dist
          zip -r parthenon-core-${VERSION}-win-x86_64.zip parthenon-core/
          cd ..
          
          # Generate archive checksum
          cd dist
          sha256sum parthenon-core-${VERSION}-win-x86_64.zip > parthenon-core-${VERSION}-win-x86_64.zip.sha256
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-windows-x86_64
          path: |
            dist/parthenon-core-${{ env.VERSION }}-win-x86_64.zip
            dist/parthenon-core-${{ env.VERSION }}-win-x86_64.zip.sha256

  build-macos:
    name: Build macOS (x86_64 + arm64)
    runs-on: macos-12
    strategy:
      matrix:
        arch: [x86_64, arm64]
    env:
      BUILD_DIR: build-${{ matrix.arch }}
      VERSION: >-
        ${{ github.event_name == 'workflow_dispatch' &&
        inputs.version_tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake ninja openssl@3 boost leveldb

      - name: Configure
        run: >-
          cmake -S . -B "${BUILD_DIR}" -G Ninja
          -DCMAKE_BUILD_TYPE="${BUILD_TYPE}"
          -DCMAKE_OSX_ARCHITECTURES="${{ matrix.arch }}"
          -DDRACHMA_BUILD_GUI=OFF
          -DDRACHMA_BUILD_TESTS=OFF
          -DDRACHMA_COVERAGE=OFF
          -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          -DBoost_INCLUDE_DIR=$(brew --prefix boost)/include
          -DCMAKE_C_FLAGS="-O2"
          -DCMAKE_CXX_FLAGS="-O2"

      - name: Build
        run: cmake --build "${BUILD_DIR}" --parallel

      - name: Package artifacts
        run: |
          mkdir -p dist/parthenon-core
          TARGETS=(drachmad drachma-cli drachma_cpu_miner)
          for name in "${TARGETS[@]}"; do
            bin_path=$(find "${BUILD_DIR}" -maxdepth 3 -type f \
              -name "${name}" -print -quit)
            if [ -n "${bin_path}" ]; then
              strip "${bin_path}"
              cp "${bin_path}" dist/parthenon-core/
            fi
          done
          
          # Add documentation
          cp README.md dist/parthenon-core/
          cp LICENSE dist/parthenon-core/
          echo "${VERSION}" > dist/parthenon-core/VERSION
          
          # Generate checksums
          cd dist/parthenon-core
          shasum -a 256 drachmad drachma-cli drachma_cpu_miner > SHA256SUMS
          cd ../..
          
          # Create archive
          tar -czf dist/parthenon-core-${VERSION}-macos-${{ matrix.arch }}.tar.gz -C dist/parthenon-core .
          
          # Generate archive checksum
          cd dist
          shasum -a 256 parthenon-core-${VERSION}-macos-${{ matrix.arch }}.tar.gz > parthenon-core-${VERSION}-macos-${{ matrix.arch }}.tar.gz.sha256
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-macos-${{ matrix.arch }}
          path: |
            dist/parthenon-core-${{ env.VERSION }}-macos-${{ matrix.arch }}.tar.gz
            dist/parthenon-core-${{ env.VERSION }}-macos-${{ matrix.arch }}.tar.gz.sha256

  build-windows-native:
    name: Build Windows Native Installer
    runs-on: windows-latest
    env:
      BUILD_DIR: build-native
      VERSION: >-
        ${{ github.event_name == 'workflow_dispatch' &&
        inputs.version_tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Chocolatey
        uses: crazy-max/ghaction-chocolatey@v3

      - name: Install OpenSSL
        run: choco install openssl --no-progress

      - name: Install CMake
        run: choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' --no-progress

      - name: Install Boost
        run: choco install boost-msvc-14.3 --no-progress

      - name: Configure CMake
        run: |
          cmake -S . -B $env:BUILD_DIR -G "Visual Studio 17 2022" -A x64 `
            -DOPENSSL_ROOT_DIR="C:/Program Files/OpenSSL-Win64" `
            -DCMAKE_BUILD_TYPE=Release `
            -DDRACHMA_BUILD_TESTS=OFF `
            -DDRACHMA_BUILD_GUI=OFF

      - name: Build
        run: cmake --build $env:BUILD_DIR --config Release --parallel

      - name: Package Installer
        run: |
          cd $env:BUILD_DIR
          cpack -C Release

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-windows-native
          path: |
            build-native/*.exe
            build-native/*.zip

  build-qt-wallet:
    name: Build Qt Desktop Wallet
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: release-qt-wallet-windows
          - os: macos-12
            artifact_name: release-qt-wallet-macos
          - os: ubuntu-20.04
            artifact_name: release-qt-wallet-linux
    env:
      VERSION: >-
        ${{ github.event_name == 'workflow_dispatch' &&
        inputs.version_tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          modules: 'qtwebengine qtwebview'

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install openssl cmake boost-msvc-14.3 --no-progress

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja openssl@3 boost leveldb

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update && sudo apt-get install -y \
            cmake ninja-build libssl-dev libboost-all-dev libleveldb-dev

      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DOPENSSL_ROOT_DIR="C:/Program Files/OpenSSL-Win64" `
            -DCMAKE_BUILD_TYPE=Release `
            -DDRACHMA_BUILD_TESTS=OFF `
            -DDRACHMA_BUILD_GUI=ON `
            -DCMAKE_PREFIX_PATH="${env:Qt6_DIR}"

      - name: Configure CMake (macOS)
        if: runner.os == 'macOS'
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DDRACHMA_BUILD_TESTS=OFF \
            -DDRACHMA_BUILD_GUI=ON \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
            -DBoost_INCLUDE_DIR=$(brew --prefix boost)/include \
            -DCMAKE_PREFIX_PATH="${Qt6_DIR}"

      - name: Configure CMake (Linux)
        if: runner.os == 'Linux'
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DDRACHMA_BUILD_TESTS=OFF \
            -DDRACHMA_BUILD_GUI=ON \
            -DCMAKE_PREFIX_PATH="${Qt6_DIR}"

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: |
          cd build
          cpack -C Release -G NSIS

      - name: Package (macOS)
        if: runner.os == 'macOS'
        run: |
          cd build
          cpack -G DragNDrop

      - name: Package (Linux)
        if: runner.os == 'Linux'
        run: |
          cd build
          cpack -G DEB
          cpack -G RPM

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            build/*.exe
            build/*.dmg
            build/*.deb
            build/*.rpm

  build-mobile-client:
    name: Build Mobile Client
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: android
            artifact_name: release-mobile-android
          - os: macos-12
            platform: ios
            artifact_name: release-mobile-ios
    defaults:
      run:
        working-directory: mobile-client
    env:
      VERSION: >-
        ${{ github.event_name == 'workflow_dispatch' &&
        inputs.version_tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: mobile-client/package-lock.json

      - name: Setup Java (Android)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Cache Gradle (Android)
        if: matrix.platform == 'android'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Build Android APK
        if: matrix.platform == 'android'
        run: |
          if [ -d "android" ]; then
            cd android
            ./gradlew assembleRelease --no-daemon
          else
            echo "Android directory not found, skipping Android build"
            exit 0
          fi

      - name: Install CocoaPods (iOS)
        if: matrix.platform == 'ios'
        run: |
          if [ -d "ios" ]; then
            cd ios
            pod install
          else
            echo "iOS directory not found, skipping iOS build"
            exit 0
          fi

      - name: Build iOS Archive
        if: matrix.platform == 'ios'
        run: |
          if [ -d "ios" ]; then
            cd ios
            xcodebuild -workspace DrachmaWallet.xcworkspace \
              -scheme DrachmaWallet \
              -configuration Release \
              -archivePath $PWD/build/DrachmaWallet.xcarchive \
              archive \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO
          else
            echo "iOS directory not found, skipping iOS build"
            exit 0
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            mobile-client/android/app/build/outputs/apk/release/*.apk
            mobile-client/ios/build/*.xcarchive
          if-no-files-found: warn

  build-explorer:
    name: Build Explorer
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: explorer
    env:
      VERSION: >-
        ${{ github.event_name == 'workflow_dispatch' &&
        inputs.version_tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./explorer
          push: false
          tags: drachma-explorer:${{ env.VERSION }}
          outputs: type=docker,dest=/tmp/drachma-explorer-${{ env.VERSION }}.tar

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
            pip install pyinstaller
          else
            echo "Error: requirements.txt not found" >&2
            exit 1
          fi

      - name: Build standalone executable
        run: |
          pyinstaller --onefile --name drachma-explorer app.py

      - name: Package Explorer
        run: |
          mkdir -p dist/explorer-package
          cp dist/drachma-explorer dist/explorer-package/
          cp -r templates dist/explorer-package/
          cp index.html dist/explorer-package/
          cp style.css dist/explorer-package/
          cp app.js dist/explorer-package/
          echo "${{ env.VERSION }}" > dist/explorer-package/VERSION
          
          # Create README
          cat > dist/explorer-package/README.txt << 'EOF'
          PARTHENON CHAIN Explorer

          This package contains a standalone blockchain explorer for PARTHENON CHAIN.

          Prerequisites:
          - A running PARTHENON CHAIN node with RPC enabled

          Configuration:
          Set the following environment variables:
          - DRACHMA_RPC_URL: RPC endpoint (default: http://localhost:18443)
          - DRACHMA_RPC_USER: RPC username
          - DRACHMA_RPC_PASS: RPC password
          - DRACHMA_NETWORK: Network type (mainnet/testnet/regtest)

          To run:
          ./drachma-explorer

          For Docker deployment, use the docker image artifact.

          See https://github.com/Tsoympet/PARTHENON-CHAIN for more information.
          EOF
          
          # Create tarball
          cd dist
          tar -czf explorer-${VERSION}-linux-x86_64.tar.gz explorer-package/
          sha256sum explorer-${VERSION}-linux-x86_64.tar.gz > explorer-${VERSION}-linux-x86_64.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-explorer
          path: |
            /tmp/drachma-explorer-${{ env.VERSION }}.tar
            explorer/dist/explorer-${{ env.VERSION }}-linux-x86_64.tar.gz
            explorer/dist/explorer-${{ env.VERSION }}-linux-x86_64.tar.gz.sha256

  publish:
    if: >-
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' &&
      inputs.publish_release == 'true')
    name: Publish release
    needs: [build-linux, build-windows, build-macos, build-windows-native, build-qt-wallet, build-mobile-client, build-explorer]
    runs-on: ubuntu-latest
    env:
      VERSION: >-
        ${{ github.event_name == 'workflow_dispatch' &&
        inputs.version_tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: release-*
          merge-multiple: false

      - name: Prepare release assets
        run: |
          mkdir -p dist
          # Core binaries
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" \) -exec cp {} dist/ \;
          # Windows native installers
          find artifacts/release-windows-native -type f \( -name "*.exe" \) -exec cp {} dist/ \; 2>/dev/null || true
          # Qt wallet installers
          find artifacts/release-qt-wallet-* -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.deb" -o -name "*.rpm" \) -exec cp {} dist/ \; 2>/dev/null || true
          # Mobile client builds
          find artifacts/release-mobile-* -type f \( -name "*.apk" -o -name "*.xcarchive" \) -exec cp {} dist/ \; 2>/dev/null || true
          # Explorer builds
          find artifacts/release-explorer -type f \( -name "*.tar" -o -name "*.tar.gz" -o -name "*.sha256" \) -exec cp {} dist/ \; 2>/dev/null || true
          ls -lh dist/

      - name: Sign release artifacts (if GPG key available)
        if: ${{ secrets.GPG_PRIVATE_KEY != '' }}
        run: |
          if [ -n "${{ secrets.GPG_PRIVATE_KEY }}" ]; then
            echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
            for file in dist/*.tar.gz dist/*.zip dist/*.exe dist/*.dmg dist/*.deb dist/*.rpm dist/*.apk dist/*.tar; do
              if [ -f "$file" ]; then
                gpg --batch --yes --detach-sign --armor "$file"
              fi
            done
            echo "Release artifacts signed with GPG"
          fi

      - name: Compose release notes
        run: |
          python - <<'PY'
          import pathlib
          import re
          import os

          version = os.environ["VERSION"]
          pattern = re.compile(rf"^##\s+\[?{re.escape(version)}\]?")
          
          changelog_path = pathlib.Path("doc/CHANGELOG.md")
          if not changelog_path.exists():
              changelog_path = pathlib.Path("CHANGELOG.md")
          
          if changelog_path.exists():
              lines = changelog_path.read_text().splitlines()
              capture = False
              out = []
              for line in lines:
                  if pattern.match(line):
                      capture = True
                      continue
                  if capture and line.startswith("## "):
                      break
                  if capture:
                      out.append(line)
              
              notes_path = pathlib.Path("release_notes.md")
              if out:
                  notes_path.write_text("\n".join(out).strip() + "\n")
              else:
                  notes_path.write_text(
                      f"PARTHENON CHAIN {version}\n\n"
                      "## Core Binaries\n\n"
                      "This release includes core binaries for:\n"
                      "- Linux x86_64\n"
                      "- Windows x86_64 (Portable ZIP - cross-compiled)\n"
                      "- Windows x86_64 (Native Installer - NSIS)\n"
                      "- macOS x86_64 (Intel)\n"
                      "- macOS arm64 (Apple Silicon)\n\n"
                      "## Desktop Wallet (Qt)\n\n"
                      "Desktop GUI wallet available for:\n"
                      "- Windows (NSIS installer)\n"
                      "- macOS (DMG)\n"
                      "- Linux (DEB and RPM packages)\n\n"
                      "## Mobile Wallet\n\n"
                      "Mobile wallet builds:\n"
                      "- Android APK\n"
                      "- iOS Archive (requires signing for installation)\n\n"
                      "## Blockchain Explorer\n\n"
                      "Explorer packages:\n"
                      "- Standalone Linux binary\n"
                      "- Docker image\n\n"
                      "## Verification\n\n"
                      "Always verify checksums before running binaries.\n"
                      "See docs/verifying-downloads.md for instructions.\n"
                  )
          else:
              pathlib.Path("release_notes.md").write_text(
                  f"PARTHENON CHAIN {version}\n\n"
                  "Release binaries for all supported platforms.\n"
              )
          PY

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: PARTHENON CHAIN ${{ env.VERSION }}
          body_path: release_notes.md
          files: dist/*
          draft: false
          prerelease: >-
            ${{ contains(env.VERSION, 'rc') || contains(env.VERSION, 'test') || contains(env.VERSION, 'dev') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
