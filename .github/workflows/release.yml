name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version_tag:
        description: "Version label to use when manually triggering"
        required: true
        default: "v0.0.0-devtest"
      publish_release:
        description: "Publish a GitHub release (false for dry-run)"
        type: choice
        options: ["false", "true"]
        default: "false"
        required: true

permissions:
  contents: write
  id-token: write

env:
  BUILD_TYPE: Release

jobs:
  build:
    name: Build and package (ubuntu-latest)
    runs-on: ubuntu-latest
    env:
      BUILD_DIR: build
      VERSION: ${{ github.event_name == 'workflow_dispatch' && inputs.version_tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build libssl-dev libboost-all-dev libleveldb-dev

      - name: Configure
        run: cmake -S . -B "${BUILD_DIR}" -G Ninja -DCMAKE_BUILD_TYPE="${BUILD_TYPE}" -DDRACHMA_BUILD_GUI=OFF -DDRACHMA_BUILD_TESTS=OFF

      - name: Build
        run: cmake --build "${BUILD_DIR}" --parallel

      - name: Package artifacts
        run: |
          mkdir -p dist/ubuntu
          TARGETS=(drachmad drachma-cli drachma_cpu_miner)
          for name in "${TARGETS[@]}"; do
            bin_path=$(find "${BUILD_DIR}" -maxdepth 3 -type f -name "${name}" -print -quit)
            if [ -n "${bin_path}" ]; then
              cp "${bin_path}" dist/ubuntu/
            else
              echo "Warning: ${name} was not produced by the build; skipping." >&2
            fi
          done
          if [ -z "$(find dist/ubuntu -maxdepth 1 -type f -print -quit)" ]; then
            echo "No binaries were packaged from the build output." >&2
            exit 1
          fi
          tar -czf dist/drachma-${VERSION}-linux.tar.gz -C dist/ubuntu .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-ubuntu
          path: dist/drachma-${{ env.VERSION }}-linux.tar.gz

  publish:
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish_release == 'true')
    name: Publish release
    needs: build
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event_name == 'workflow_dispatch' && inputs.version_tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          if-no-artifacts-found: error

      - name: Prepare release assets
        run: |
          ls -R artifacts
          mkdir -p dist
          find artifacts -type f -name '*.tar.gz' -exec cp {} dist/ \;
          if [ -z "$(find dist -type f -print -quit)" ]; then
            echo "No packaged artifacts found." >&2
            exit 1
          fi

      - name: Compose release notes
        run: |
          python - <<'PY'
import pathlib
import re
import os

version = os.environ["VERSION"]
pattern = re.compile(rf"^##\s+\[?{re.escape(version)}\]?")
lines = pathlib.Path("CHANGELOG.md").read_text().splitlines()

capture = False
out = []
for line in lines:
    if pattern.match(line):
        capture = True
        continue
    if capture and line.startswith("## "):
        break
    if capture:
        out.append(line)

notes_path = pathlib.Path("release_notes.md")
if out:
    notes_path.write_text("\n".join(out).strip() + "\n")
else:
    notes_path.write_text(f"Drachma {version}\nRelease notes not found in CHANGELOG.md\n")
PY

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: Drachma ${{ env.VERSION }}
          body_path: release_notes.md
          files: dist/*
          draft: false
          prerelease: ${{ contains(env.VERSION, 'rc') || contains(env.VERSION, 'test') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
