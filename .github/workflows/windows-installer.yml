name: Windows Build & Installer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Chocolatey
        uses: crazy-max/ghaction-chocolatey@v3
        with:
          args: --version

      - name: Install CMake
        run: choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' --no-progress

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'a42af01b72c28a8e1d7b48107b33e4f286a55ef6'

      - name: Install dependencies via vcpkg
        run: |
          vcpkg install openssl:x64-windows boost-system:x64-windows leveldb:x64-windows

      - name: Configure CMake
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_TOOLCHAIN_FILE="${env:VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DCMAKE_BUILD_TYPE=Release `
            -DDRACHMA_BUILD_TESTS=OFF `
            -DDRACHMA_BUILD_GUI=OFF

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Package Installer
        run: |
          cd build
          cpack -C Release

      - name: Upload Installer Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: drachma-installers
          path: |
            build/*.exe
            build/*.zip
          if-no-files-found: warn
          retention-days: 7
