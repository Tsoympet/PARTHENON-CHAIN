name: Explorer Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-docker:
    name: Build Explorer Docker Image
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: explorer
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./explorer
          push: false
          tags: drachma-explorer:latest
          outputs: type=docker,dest=/tmp/drachma-explorer.tar

      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: drachma-explorer-docker
          path: /tmp/drachma-explorer.tar
          retention-days: 7

  build-standalone:
    name: Build Explorer Standalone Package
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: explorer
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build standalone executable
        run: |
          pyinstaller --onefile --name drachma-explorer app.py

      - name: Package Explorer
        run: |
          mkdir -p dist/explorer-package
          cp dist/drachma-explorer dist/explorer-package/
          cp -r templates dist/explorer-package/
          cp -r static dist/explorer-package/ || true
          cp index.html dist/explorer-package/
          cp style.css dist/explorer-package/
          cp app.js dist/explorer-package/
          
          # Create README
          cat > dist/explorer-package/README.txt << 'EOF'
          PARTHENON CHAIN Explorer

          This package contains a standalone blockchain explorer for PARTHENON CHAIN.

          Prerequisites:
          - A running PARTHENON CHAIN node with RPC enabled

          Configuration:
          Set the following environment variables:
          - DRACHMA_RPC_URL: RPC endpoint (default: http://localhost:18443)
          - DRACHMA_RPC_USER: RPC username
          - DRACHMA_RPC_PASS: RPC password
          - DRACHMA_NETWORK: Network type (mainnet/testnet/regtest)

          To run:
          Linux/macOS: ./drachma-explorer
          Windows: Use the Docker image or run from source

          For Docker deployment:
          docker run -p 5000:5000 -e DRACHMA_RPC_URL=... drachma-explorer

          See https://github.com/Tsoympet/PARTHENON-CHAIN for more information.
          EOF
          
          # Create tarball
          cd dist
          tar -czf explorer-standalone-linux-x86_64.tar.gz explorer-package/

      - name: Upload Explorer Package
        uses: actions/upload-artifact@v4
        with:
          name: drachma-explorer-standalone
          path: explorer/dist/explorer-standalone-linux-x86_64.tar.gz
          retention-days: 7

  build-static:
    name: Build Explorer Static Files
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: explorer
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Package static files
        run: |
          mkdir -p dist/explorer-static
          cp index.html dist/explorer-static/
          cp style.css dist/explorer-static/
          cp app.js dist/explorer-static/
          cp -r templates dist/explorer-static/ || true
          
          # Create deployment instructions
          cat > dist/explorer-static/DEPLOYMENT.md << 'EOF'
          # PARTHENON CHAIN Explorer - Static Deployment

          ## Files
          - `index.html` - Main HTML file
          - `style.css` - Stylesheet
          - `app.js` - Client-side JavaScript
          - `templates/` - Server-side templates (for Flask deployment)

          ## Deployment Options

          ### Option 1: Static Web Server
          Deploy the static files to any web server (nginx, Apache, etc.)

          ### Option 2: Flask Application
          1. Install Python 3.11+
          2. Install requirements: `pip install -r requirements.txt`
          3. Run: `python app.py`

          ### Option 3: Docker
          Use the Docker image from the docker artifact

          ## Configuration
          Update `app.js` to point to your RPC endpoint or use a backend proxy.
          EOF
          
          # Create zip archive
          cd dist
          zip -r explorer-static.zip explorer-static/

      - name: Upload Static Files
        uses: actions/upload-artifact@v4
        with:
          name: drachma-explorer-static
          path: explorer/dist/explorer-static.zip
          retention-days: 7
